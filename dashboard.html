<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Doctor's Fee Portal — Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">

  <!-- NAVBAR -->
  <nav class="bg-white shadow px-6 py-4 flex justify-between items-center">
    <div class="flex items-center gap-4">
      <h1 class="text-xl font-bold">Doctor's Fee Portal</h1>
      <span id="roleBadge" class="text-sm text-gray-600 hidden"></span>
    </div>

    <div class="flex items-center gap-3">
      <button id="navPatients" class="text-sm hover:text-blue-600">Cases</button>
      <button id="navAdd" class="text-sm hover:text-blue-600">Add Case</button>
      <button id="navReports" class="text-sm hover:text-blue-600">Reports</button>
      <button id="logoutBtn" class="ml-4 bg-red-500 text-white px-3 py-1 rounded">Logout</button>
    </div>
  </nav>

  <main class="p-6 max-w-6xl mx-auto">

    <!-- Add Case / Patient form -->
    <section id="pageAdd" class="bg-white p-6 rounded-lg shadow">
      <h2 class="text-2xl font-semibold mb-4">Add Case / Patient</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block font-medium">Case No</label>
          <input id="case_no" class="w-full border p-2 rounded" placeholder="e.g. CASE-20251212-001" />
        </div>

        <div>
          <label class="block font-medium">Case Date</label>
          <input id="case_date" type="date" class="w-full border p-2 rounded" />
        </div>

        <div>
          <label class="block font-medium">Patient</label>
          <select id="patient_select" class="w-full border p-2 rounded"></select>
          <div class="mt-2 text-sm">
            <label class="inline-flex items-center gap-2">
              <input id="toggle_new_patient" type="checkbox" /> <span>Add new patient inline</span>
            </label>
          </div>
        </div>

        <div id="newPatientContainer" class="space-y-2 hidden">
          <div>
            <label class="block font-medium">Full name</label>
            <input id="new_full_name" class="w-full border p-2 rounded" />
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block font-medium">Gender</label>
              <select id="new_gender" class="w-full border p-2 rounded">
                <option>Male</option>
                <option>Female</option>
              </select>
            </div>
            <div>
              <label class="block font-medium">Age</label>
              <input id="new_age" type="number" class="w-full border p-2 rounded" />
            </div>
          </div>
          <div>
            <label class="block font-medium">Contact</label>
            <input id="new_contact" class="w-full border p-2 rounded" />
          </div>
          <div>
            <label class="block font-medium">Address</label>
            <input id="new_address" class="w-full border p-2 rounded" />
          </div>
        </div>
      </div>

      <!-- Procedures -->
      <div class="mb-4">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold">Procedures</h3>
          <div class="text-sm text-gray-600">Add one or more procedures</div>
        </div>

        <div id="proceduresContainer" class="space-y-2 mt-3"></div>

        <div class="mt-2">
          <button id="addProcedureBtn" class="bg-blue-600 text-white px-3 py-1 rounded">+ Add Procedure</button>
        </div>

        <div class="mt-4 flex justify-end items-center gap-4">
          <div class="text-lg">
            <span class="font-semibold">Total:</span>
            <span id="proceduresTotal">0.00</span>
          </div>
          <button id="saveCaseBtn" class="bg-green-600 text-white px-4 py-2 rounded">Save Case</button>
        </div>
      </div>
    </section>

    <!-- Cases table -->
    <section id="pageCases" class="mt-6 bg-white p-6 rounded-lg shadow hidden">
      <h2 class="text-2xl font-semibold mb-4">Recent Cases</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-sm font-medium">Case No</th>
              <th class="px-4 py-2 text-left text-sm font-medium">Date</th>
              <th class="px-4 py-2 text-left text-sm font-medium">Patient</th>
              <th class="px-4 py-2 text-left text-sm font-medium">Procedures</th>
              <th class="px-4 py-2 text-left text-sm font-medium">Created By</th>
            </tr>
          </thead>
          <tbody id="casesTbody" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </section>

    <!-- Reports placeholder -->
    <section id="pageReports" class="mt-6 bg-white p-6 rounded-lg shadow hidden">
      <h2 class="text-2xl font-semibold mb-4">Reports</h2>
      <p class="text-gray-600">Reports and analytics will go here.</p>
    </section>

  </main>

  <script>
  // --------------------------
  // Config (your project keys)
  // --------------------------
  const SUPABASE_URL = "https://qmjjfrpwjewcrnavdsks.supabase.co";
  const SUPABASE_KEY = "sb_publishable_vToTFZu23icWOnjMn9zSxQ_LiR0SINF";

  // Single client
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // Simple DOM selectors
  const pageAdd = document.getElementById('pageAdd');
  const pageCases = document.getElementById('pageCases');
  const pageReports = document.getElementById('pageReports');

  const navPatients = document.getElementById('navPatients');
  const navAdd = document.getElementById('navAdd');
  const navReports = document.getElementById('navReports');

  const logoutBtn = document.getElementById('logoutBtn');
  const roleBadge = document.getElementById('roleBadge');

  // form controls
  const patientSelect = document.getElementById('patient_select');
  const toggleNewPatient = document.getElementById('toggle_new_patient');
  const newPatientContainer = document.getElementById('newPatientContainer');
  const proceduresContainer = document.getElementById('proceduresContainer');
  const addProcedureBtn = document.getElementById('addProcedureBtn');
  const proceduresTotalEl = document.getElementById('proceduresTotal');
  const saveCaseBtn = document.getElementById('saveCaseBtn');

  const casesTbody = document.getElementById('casesTbody');

  // Session / user
  let currentUser = null;
  (async function initAuth(){
    const { data } = await supabase.auth.getSession();
    if (!data?.session) {
      window.location.href = 'index.html';
      return;
    }
    currentUser = data.session.user;
    // load role from app_users if available
    try {
      const { data: profile } = await supabase.from('app_users').select('role').eq('auth_uid', currentUser.id).single();
      if (profile?.role) {
        roleBadge.textContent = profile.role.toUpperCase();
        roleBadge.classList.remove('hidden');
      }
    } catch(e){ console.warn('no profile row', e); }

    // initialize UI data
    await loadPatients();
    await loadDoctorFees();
    await loadCases();
  })();

  // logout
  logoutBtn.addEventListener('click', async () => {
    await supabase.auth.signOut();
    window.location.href = 'index.html';
  });

  // nav
  navPatients.addEventListener('click', () => showPage('cases'));
  navAdd.addEventListener('click', () => showPage('add'));
  navReports.addEventListener('click', () => showPage('reports'));

  function showPage(name){
    pageAdd.classList.add('hidden');
    pageCases.classList.add('hidden');
    pageReports.classList.add('hidden');
    if (name === 'add') pageAdd.classList.remove('hidden');
    if (name === 'cases') pageCases.classList.remove('hidden');
    if (name === 'reports') pageReports.classList.remove('hidden');
  }

  // Patients
  async function loadPatients(){
    const { data, error } = await supabase.from('patients').select('id, full_name').order('created_at', { ascending:false });
    patientSelect.innerHTML = '<option value="">-- Select patient --</option>';
    if (error) {
      console.error('loadPatients error', error);
      return;
    }
    data.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.full_name;
      patientSelect.appendChild(opt);
    });
    // Add "add new" option optionally
    const addOpt = document.createElement('option');
    addOpt.value = '__new';
    addOpt.textContent = '-- Add new patient --';
    patientSelect.appendChild(addOpt);

    // toggle for new patient when select changes
    patientSelect.addEventListener('change', () => {
      const v = patientSelect.value;
      if (v === '__new') {
        toggleNewPatient.checked = true;
        newPatientContainer.classList.remove('hidden');
      } else {
        toggleNewPatient.checked = false;
        newPatientContainer.classList.add('hidden');
      }
    });
  }

  toggleNewPatient.addEventListener('change', () => {
    newPatientContainer.classList.toggle('hidden', !toggleNewPatient.checked);
    if (!toggleNewPatient.checked) patientSelect.value = '';
  });

  // Doctor fees list (used to populate dropdown inside each procedure row)
  let doctorFeesCache = [];
  async function loadDoctorFees(){
    // We read from doctor_fees table which contains doctor_name and fee_amount
    const { data, error } = await supabase.from('doctor_fees').select('id, doctor_name, fee_amount').order('doctor_name');
    if (error) {
      console.error('loadDoctorFees error', error);
      return;
    }
    doctorFeesCache = data || [];
    // ensure at least one procedure row exists
    if (proceduresContainer.children.length === 0) addProcedureRow();
  }

  // Add / remove procedure rows
  function addProcedureRow(procedure = { procedure_name:'', doctor_fee_id:'', fee_amount:0 }){
    const row = document.createElement('div');
    row.className = 'grid grid-cols-12 gap-2 items-center p-2 border rounded';
    row.innerHTML = `
      <div class="col-span-5">
        <input class="w-full p-2 border rounded procedure-name" placeholder="Procedure name" value="${escapeHtml(procedure.procedure_name)}" />
      </div>
      <div class="col-span-4">
        <select class="w-full p-2 border rounded procedure-doctor">
          <option value="">Select doctor (fee)</option>
        </select>
      </div>
      <div class="col-span-2">
        <input type="number" class="w-full p-2 border rounded procedure-fee" step="0.01" value="${procedure.fee_amount ?? 0}" />
      </div>
      <div class="col-span-1 text-right">
        <button type="button" class="remove-proc text-sm text-red-600">Remove</button>
      </div>
    `;
    proceduresContainer.appendChild(row);

    // populate doctor select
    const doctorSelect = row.querySelector('.procedure-doctor');
    doctorFeesCache.forEach(df => {
      const opt = document.createElement('option');
      opt.value = df.id;
      opt.textContent = `${df.doctor_name} — ${formatCurrency(df.fee_amount)}`;
      opt.dataset.fee = df.fee_amount;
      doctorSelect.appendChild(opt);
    });

    // when doctor changed -> set fee
    doctorSelect.addEventListener('change', (e)=>{
      const sel = e.target;
      const feeEl = row.querySelector('.procedure-fee');
      const fee = sel.selectedOptions[0]?.dataset?.fee;
      if (fee !== undefined) {
        feeEl.value = Number(fee);
      }
      computeProceduresTotal();
    });

    // remove
    row.querySelector('.remove-proc').addEventListener('click', ()=> {
      row.remove();
      computeProceduresTotal();
    });

    // change fee recompute
    row.querySelector('.procedure-fee').addEventListener('input', computeProceduresTotal);
    row.querySelector('.procedure-name').addEventListener('input', ()=>{});
    computeProceduresTotal();
  }

  addProcedureBtn.addEventListener('click', ()=> addProcedureRow());

  function computeProceduresTotal(){
    const fees = [...proceduresContainer.querySelectorAll('.procedure-fee')].map(i => parseFloat(i.value) || 0);
    const total = fees.reduce((a,b)=>a+b,0);
    proceduresTotalEl.textContent = formatCurrency(total);
    return total;
  }

  function formatCurrency(n){
    if (isNaN(n)) n = 0;
    return Number(n).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  // Cases listing
  async function loadCases(){
    const { data, error } = await supabase.from('cases').select('case_no, case_date, patient_name, procedure_name, created_by').order('created_at', { ascending:false }).limit(100);
    casesTbody.innerHTML = '';
    if (error) {
      console.error('loadCases error', error);
      return;
    }
    data.forEach(c => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="px-4 py-2 text-sm">${escapeHtml(c.case_no || '')}</td>
        <td class="px-4 py-2 text-sm">${c.case_date ? new Date(c.case_date).toLocaleDateString() : ''}</td>
        <td class="px-4 py-2 text-sm">${escapeHtml(c.patient_name || '')}</td>
        <td class="px-4 py-2 text-sm">${escapeHtml(c.procedure_name || '')}</td>
        <td class="px-4 py-2 text-sm">${escapeHtml(c.created_by || '')}</td>
      `;
      casesTbody.appendChild(tr);
    });
  }

  // Save case flow
  saveCaseBtn.addEventListener('click', async () => {
    saveCaseBtn.disabled = true;
    saveCaseBtn.textContent = 'Saving...';

    try {
      // gather patient
      let patientId = patientSelect.value;
      let patientName = '';
      if (patientId === '__new' || toggleNewPatient.checked){
        // create patient
        const newFull = document.getElementById('new_full_name').value.trim();
        if (!newFull) throw new Error('New patient name is required');
        const newGender = document.getElementById('new_gender').value;
        const newAge = document.getElementById('new_age').value || null;
        const newContact = document.getElementById('new_contact').value || null;
        const newAddress = document.getElementById('new_address').value || null;

        const { data: pData, error: pErr } = await supabase
          .from('patients')
          .insert([{
            full_name: newFull,
            gender: newGender,
            age: newAge,
            contact_no: newContact,
            address: newAddress
          }]).select().single();

        if (pErr) throw pErr;
        patientId = pData.id;
        patientName = pData.full_name;
      } else {
        // using existing patient
        const opt = patientSelect.selectedOptions[0];
        patientName = opt ? opt.textContent : '';
      }

      // gather case fields
      const caseNo = document.getElementById('case_no').value || generateCaseNo();
      const caseDate = document.getElementById('case_date').value || new Date().toISOString().split('T')[0];

      // gather procedures
      const procRows = [...proceduresContainer.querySelectorAll('div')]; // each row
      const procedures = procRows.map(r => ({
        procedure_name: r.querySelector('.procedure-name').value.trim(),
        doctor_fee_id: r.querySelector('.procedure-doctor').value || null,
        fee_amount: parseFloat(r.querySelector('.procedure-fee').value) || 0
      })).filter(p => p.procedure_name || p.doctor_fee_id);

      if (procedures.length === 0) {
        alert('Please add at least one procedure.');
        return;
      }

      // Insert into cases table
      const proceduresJoined = procedures.map(p => p.procedure_name || '').join(', ');

      // get user id (created_by)
      const { data: sessionData } = await supabase.auth.getSession();
      const userId = sessionData?.session?.user?.id || null;

      const { data: caseData, error: caseErr } = await supabase
        .from('cases')
        .insert([{
          case_no: caseNo,
          case_date: caseDate,
          patient_id: patientId,
          patient_name: patientName || (document.getElementById('new_full_name')?.value || ''),
          procedure_name: proceduresJoined,
          created_by: userId
        }]).select().single();

      if (caseErr) throw caseErr;

      // Optionally insert per-procedure rows into a separate table if you have it (case_procedures)
      try {
        // will fail silently if table doesn't exist; that's fine
        await Promise.all(procedures.map(p =>
          supabase.from('case_procedures').insert([{
            case_id: caseData.id,
            procedure_name: p.procedure_name,
            doctor_fee_id: p.doctor_fee_id,
            fee_amount: p.fee_amount
          }])
        ));
      } catch(e){
        // ignore (table might not exist) but log
        console.warn('case_procedures insert skipped or errored:', e);
      }

      // success -> update UI
      alert('Case saved successfully.');
      // reset form
      document.getElementById('case_no').value = '';
      document.getElementById('case_date').value = '';
      patientSelect.value = '';
      toggleNewPatient.checked = false;
      newPatientContainer.classList.add('hidden');
      // clear procedures
      proceduresContainer.innerHTML = '';
      addProcedureRow();
      computeProceduresTotal();
      await loadPatients();
      await loadCases();

    } catch (err) {
      console.error('Save case error', err);
      alert('Failed to save: ' + (err.message || JSON.stringify(err)));
    } finally {
      saveCaseBtn.disabled = false;
      saveCaseBtn.textContent = 'Save Case';
    }
  });

  function generateCaseNo(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const random = Math.floor(Math.random()*9000)+1000;
    return `CASE-${yyyy}${mm}${dd}-${random}`;
  }

  // small helpers
  function escapeHtml(s){
    if (!s && s !== 0) return '';
    return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  }
  </script>
</body>
</html>
