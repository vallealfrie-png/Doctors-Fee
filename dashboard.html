<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <nav class="bg-blue-700 text-white px-6 py-4 flex justify-between items-center shadow-lg">
    <h1 class="text-xl font-bold">Clinic Dashboard</h1>
    <div class="space-x-4">
      <a href="dashboard.html" class="hover:underline">Patients</a>
      <a href="reports.html" class="hover:underline">Reports</a>
      <button id="logoutBtn" class="bg-red-500 px-3 py-1 rounded">Logout</button>
    </div>
  </nav>

  <div class="p-6 max-w-5xl mx-auto">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold">Patient List</h2>
      <button id="openAddModal" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Add Patient</button>
    </div>

    <div class="mb-4 flex gap-2">
      <input id="searchInput" type="text" placeholder="Search patient name..." class="px-3 py-2 border rounded w-64">
      <button id="searchBtn" class="bg-blue-600 text-white px-3 py-2 rounded">Search</button>
      <button id="clearBtn" class="bg-gray-400 text-white px-3 py-2 rounded">Clear</button>
    </div>

    <table class="w-full bg-white shadow rounded overflow-hidden">
      <thead class="bg-gray-200">
        <tr>
          <th class="py-2 px-3 text-left">Name</th>
          <th class="py-2 px-3">Gender</th>
          <th class="py-2 px-3">Age</th>
          <th class="py-2 px-3">Contact</th>
        </tr>
      </thead>
      <tbody id="patientTable"></tbody>
    </table>
  </div>

  <!-- ADD PATIENT MODAL -->
  <div id="addModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center p-4">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl max-h-screen overflow-y-auto">
      <h2 class="text-xl font-bold mb-4">Add Patient & Case</h2>

      <form id="addPatientForm" class="space-y-3">
        <div>
          <label class="font-semibold">Full Name</label>
          <input id="full_name" class="w-full border p-2 rounded" required />
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="font-semibold">Gender</label>
            <select id="gender" class="w-full border p-2 rounded">
              <option>Male</option>
              <option>Female</option>
            </select>
          </div>
          <div>
            <label class="font-semibold">Age</label>
            <input id="age" type="number" class="w-full border p-2 rounded" />
          </div>
        </div>

        <div>
          <label class="font-semibold">Address</label>
          <input id="address" class="w-full border p-2 rounded" />
        </div>

        <div>
          <label class="font-semibold">Contact No</label>
          <input id="contact_no" class="w-full border p-2 rounded" />
        </div>

        <!-- CASE SECTION -->
        <hr class="my-4">
        <h3 class="text-lg font-bold">Case Information</h3>

        <div>
          <label class="font-semibold">Case No.</label>
          <input id="case_no" class="w-full border p-2 rounded" required />
        </div>

        <div>
          <label class="font-semibold">Case Date</label>
          <input id="case_date" type="date" class="w-full border p-2 rounded" required />
        </div>

        <h3 class="font-semibold mt-2">Procedures</h3>
        <div id="proceduresList" class="space-y-2"></div>
        <button type="button" id="addProcedureBtn" class="bg-blue-500 text-white px-3 py-1 rounded">+ Add Procedure</button>

        <div class="flex justify-end gap-2 mt-4">
          <button type="button" id="closeAddModal" class="px-4 py-2 bg-gray-400 text-white rounded">Cancel</button>
          <button class="px-4 py-2 bg-green-600 text-white rounded">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const supabaseClient = supabase.createClient(
      "https://qmjjfrpwjewcrnavdsks.supabase.co",
      "sb_publishable_vToTFZu23icWOnjMn9zSxQ_LiR0SINF"
    );

    const logoutBtn = document.getElementById("logoutBtn");
    const patientTable = document.getElementById("patientTable");
    const searchBtn = document.getElementById("searchBtn");
    const clearBtn = document.getElementById("clearBtn");
    const searchInput = document.getElementById("searchInput");

    const addModal = document.getElementById("addModal");
    const openAddModal = document.getElementById("openAddModal");
    const closeAddModal = document.getElementById("closeAddModal");

    const proceduresList = document.getElementById("proceduresList");
    const addProcedureBtn = document.getElementById("addProcedureBtn");

    function addProcedureField() {
      const div = document.createElement("div");
      div.classList.add("border","p-2","rounded","grid","grid-cols-2","gap-2");
      div.innerHTML = `
        <div>
          <label>Procedure Name</label>
          <input class="proc_name w-full border p-2 rounded" />
        </div>
        <div>
          <label>Doctor</label>
          <select class="doctor_name w-full border p-2 rounded"></select>
        </div>
        <div>
          <label>Doctor Fee</label>
          <input class="doctor_fee w-full border p-2 rounded" disabled />
        </div>
      `;
      proceduresList.appendChild(div);
      loadDoctors(div.querySelector('.doctor_name'), div.querySelector('.doctor_fee'));
    }

    async function loadDoctors(selectEl, feeEl) {
      const { data } = await supabaseClient.from('doctor_fees').select('*');
      selectEl.innerHTML = '';
      data.forEach(doc => {
        const opt = document.createElement('option');
        opt.value = doc.fee_amount;
        opt.textContent = doc.doctor_name;
        selectEl.appendChild(opt);
      });
      selectEl.addEventListener('change', () => feeEl.value = selectEl.value);
    }

    addProcedureBtn.onclick = addProcedureField;

    openAddModal.onclick = () => addModal.classList.remove('hidden');
    closeAddModal.onclick = () => addModal.classList.add('hidden');

    logoutBtn.onclick = async () => {
      await supabaseClient.auth.signOut();
      window.location.href = 'index.html';
    };

    async function loadPatients(filter = '') {
      let query = supabaseClient.from('patients').select('*').order('created_at',{ascending:false});
      if(filter) query = query.ilike('full_name', `%${filter}%`);
      const { data } = await query;

      patientTable.innerHTML = data.map(p => `
        <tr class='border-b'>
          <td class='py-2 px-3'>${p.full_name}</td>
          <td class='py-2 px-3 text-center'>${p.gender}</td>
          <td class='py-2 px-3 text-center'>${p.age}</td>
          <td class='py-2 px-3 text-center'>${p.contact_no}</td>
        </tr>`).join('');
    }

    searchBtn.onclick = () => loadPatients(searchInput.value);
    clearBtn.onclick = () => { searchInput.value=''; loadPatients(); };

    loadPatients();
  </script>
</body>
</html>
